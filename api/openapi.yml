openapi: 3.0.3
info:
  title: LBOS Controller API
  description: |
    API Контроллера Сервиса "Больше, чем Балансировка Нагрузки" типа Open Source
  license:
    name: Apache 2.0
    url: http://www.apache.org/licenses/LICENSE-2.0.html
  version: 'v1.0.0'
tags:
  - name: services
    description: методы работы с Сервисами Балансировки
  - name: clusters
    description: методы работы с Кластерами Балансировки
  - name: zones
    description: методы работы с Зонами Безопасности
servers:
  - url: /api/v1
paths:
  /clusters:
    post:
      tags:
        - clusters
      summary: создать Кластер Балансировки
      operationId: clusterAdd
      requestBody:
        description: При передаче JSON объекта c `name` и `zoneId`, произойдёт создание новой записи в БД с автогенерацией `id`.
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Cluster"
      responses:
        "201":
          description: ответ с результирующим объектом
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Cluster"
        "303":
          $ref: "#/components/responses/AlreadyExist"
        "400":
          description: некорректный ввод
        "401":
          $ref: "#/components/responses/Unauthorized"
    get:
      tags:
        - clusters
      summary: получить список всех Кластеров Балансировки
      operationId: clusterGetAll
      responses:
        "200":
          description: массив объектов типа Кластер Балансировки
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Cluster"
        "401":
          $ref: "#/components/responses/Unauthorized"
  /clusters/{clusterId}:
    get:
      tags:
        - clusters
      summary: получить Кластер Балансировки
      operationId: clusterGetById
      parameters:
        - name: clusterId
          in: path
          description: ID Кластера Балансировки
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: объект типа Кластер Балансировки
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Cluster"
        "401":
          $ref: "#/components/responses/Unauthorized"
    put:
      tags:
        - clusters
      summary: обновить Кластер Балансировки
      operationId: clusterUpdate
      parameters:
        - name: clusterId
          in: path
          description: ID Кластера Балансировки
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Cluster"
      responses:
        "200":
          description: OK
          content: { }
        "400":
          description: некорректный ввод
          content: { }
    delete:
      tags:
        - clusters
      summary: удалить Кластер Балансировки
      operationId: clusterDelete
      parameters:
        - name: clusterId
          in: path
          description: ID Кластера Балансировки
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: контента нет
          content: { }
        "400":
          description: некорректный ввод
          content: { }

  /services:
    post:
      tags:
        - services
      summary: 'aaa'
      operationId: serviceAdd
      requestBody:
        description: 'bbb'
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Service"
      responses:
        "400":
          description: некорректный ввод
        "401":
          $ref: "#/components/responses/Unauthorized"
    get:
      tags:
        - services
      summary: ''
      operationId: serviceGetAll
      responses:
        "200":
          description: массив объектов типа Сервисы Балансировки
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Service"
        "401":
          $ref: "#/components/responses/Unauthorized"
  /services/{serviceId}:
    get:
      tags:
        - services
      summary: ''
      operationId: serviceGetById
      parameters:
        - name: serviceId
          in: path
          description: ''
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: объект типа Сервис Балансировки
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Service"
        "401":
          $ref: "#/components/responses/Unauthorized"
    delete:
      tags:
        - services
      summary: ''
      operationId: serviceDeleteById
      parameters:
        - name: serviceId
          in: path
          description: ''
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: контента нет
          content: { }
        "400":
          description: некорректный ввод
          content: { }
        "401":
          $ref: "#/components/responses/Unauthorized"

  /zones:
    post:
      tags:
        - zones
      summary: создать Зону Безопасности
      operationId: zoneAdd
      requestBody:
        description: При передаче JSON объекта с `name`, произойдёт создание новой записи в БД с автогенерацией `id`.
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Zone"
      responses:
        "201":
          description: ответ с результирующим объектом
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Zone"
        "303":
          $ref: "#/components/responses/AlreadyExist"
        "400":
          description: некорректный ввод
        "401":
          $ref: "#/components/responses/Unauthorized"

    get:
      tags:
        - zones
      summary: получить список всех Зон Безопасности
      #      description: Запрос возвращает все созданные ранее Зоны Безопасности.
      operationId: zoneGetAll
      responses:
        "200":
          description: массив объектов типа Зона Безопасности
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Zone"
        "401":
          $ref: "#/components/responses/Unauthorized"
  /zones/{zoneId}:
    get:
      tags:
        - zones
      summary: получить Зону Безопасности
      operationId: zoneGetById
      parameters:
        - name: zoneId
          in: path
          description: ID Зоны Безопасности
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: объект типа Зона Безопасности
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Zone"
        "401":
          $ref: "#/components/responses/Unauthorized"
    put:
      tags:
        - zones
      summary: обновить Зону Безопасности
      operationId: zoneUpdate
      parameters:
        - name: zoneId
          in: path
          description: ID Зоны Безопасности
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        #        description: При передаче объекта с `name`, произойдёт создание новой записи в БД с автогенерацией `id`.
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Zone"
      responses:
        "200":
          description: OK
          content: { }
        "400":
          description: некорректный ввод
          content: { }

    delete:
      tags:
        - zones
      summary: удалить Зону Безопасности
      operationId: zoneDelete
      parameters:
        - name: zoneId
          in: path
          description: ID Зоны Безопасности
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: контента нет
          content: { }
        "400":
          description: некорректный ввод
          content: { }
        "401":
          $ref: "#/components/responses/Unauthorized"

components:
  schemas:
    Cluster:
      type: object
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
          description: уникальный ID Кластера
        name:
          required: true
          type: string
          description: имя Кластера Балансировки
        zoneId:
          required: true
          type: string
          format: uuid
          description: ID Зоны Безопасности
        capacity:
          required: true
          type: number
          description: предел утилизации Кластера Балансировки
        usage:
          type: number
          readOnly: true
          description: текущая утилизация (вычисляемое значение)

    Healthcheck:
      type: object
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
        helloTimer:
          type: number
        responseTimer:
          type: number
        aliveThreshold:
          type: number
        deadThreshold:
          type: number
        quorum:
          type: number
        hysteresis:
          type: number
          description: Гистере́зис

    Real:
      type: object
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
        addr:
          type: string
          format: ipv4
        port:
          type: number
        hcAddr:
          type: string
          format: ipv4
        hcPort:
          type: number

    Service:
      required:
        - something
      type: object
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
        balancingType:
          type: string
          enum: [ round-robin, source-ip, source-ip-port, least-connection, uri, url-param, hdr, random, rdp-cookie ]
        routingType:
          type: string
          enum: [ nat, tunnel, gre-tunnel ]
        bandwidth:
          type: number
        proto:
          type: string
          enum: [ tcp, udp ]
        addr:
          type: string
          format: ipv4
        port:
          type: number
        clusterId:
          type: string
          format: uuid
        reals:
          type: array
          items:
            $ref: '#/components/schemas/Real'
        healthchecks:
          type: array
          items:
            $ref: '#/components/schemas/Healthcheck'

    Zone:
      type: object
      properties:
        id:
          type: integer
          readOnly: true
          description: уникальный ID Зоны Безопасности
        name:
          required: true
          type: string
          description: имя Зоны Безопасности

  responses:
    Unauthorized:
      description: ключ API отсутствует или неверный
      headers:
        LBOS_API_KEY:
          description: auth header
          schema:
            type: string
    AlreadyExist:
      description: объект уже существует
      headers:
        Location:
          description: redirect location
          example: asd
          schema:
            type: string

  securitySchemes:
    api_key:
      type: apiKey
      in: header
      name: LBOS_API_KEY

security:
  - api_key: [ ]
